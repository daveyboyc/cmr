{% extends "checker/base.html" %}
{% load static %}
{% load humanize %}
{% load checker_tags %}

{% block title %}{{ company_name }} - Company Details{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="page-header mb-3">
        <h1>{{ company_name }}</h1>
        <a href="{% url 'search_companies' %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-left"></i> Back to Search
        </a>
    </div>

    <!-- Navigation Links & View Toggle -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="javascript:history.back()" class="text-decoration-none">
            <i class="bi bi-arrow-left"></i> Back to Previous Page
        </a>
        <div class="dropdown ms-2">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="viewModeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-eye"></i> 
                View: 
                {% if view_mode == 'capacity' %}Capacity
                {% else %}Year/Auction
                {% endif %}
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="viewModeDropdown">
                <li>
                    <a class="dropdown-item {% if view_mode == 'year_auction' %}active{% endif %}" href="?view_mode=year_auction">
                        <i class="bi bi-calendar-week me-2"></i>View by Year/Auction
                    </a>
                </li>
                <li>
                    <a class="dropdown-item {% if view_mode == 'capacity' %}active{% endif %}" href="?view_mode=capacity">
                        <i class="bi bi-bar-chart-line me-2"></i>View by Capacity
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="{% url 'search_companies' %}?q={{ company_id|urlencode }}" target="_blank">
                        <i class="bi bi-search me-2"></i>View All on Search Page
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Debug Output -->
    {% if request.GET.debug %}
    <div class="alert alert-secondary">
        <h4>Debug Info</h4>
        <p>company_name: {{ company_name }}</p>
        <p>company_id: {{ company_id }}</p>
        <p>year_auction_data exists: {% if year_auction_data %}Yes{% else %}No{% endif %}</p>
        <p>year_auction_data length: {{ year_auction_data|length }}</p>
        <p>sort_order: {{ sort_order }}</p>
    </div>
    {% endif %}

    <!-- Error Message -->
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% if traceback %}
            <div class="alert alert-secondary">
                <pre>{{ traceback }}</pre>
            </div>
        {% endif %}
    {% endif %}

    <!-- Conditional Content Display -->
    {% if view_mode == 'capacity' %}
        {# --- CAPACITY VIEW --- #}
        <div class="capacity-view">
            <h2 class="h4 mb-3">Components Ranked by De-rated Capacity</h2>

            <!-- Sort Toggle Buttons -->
            <div class="d-flex justify-content-end mb-3">
                <a href="?view_mode=capacity&sort={% if sort_order == 'desc' %}asc{% else %}desc{% endif %}" 
                   class="btn btn-outline-secondary btn-sm">
                    {% if sort_order == "desc" %}
                        <i class="bi bi-arrow-up-short"></i> Sort: Smallest First
                    {% else %}
                        <i class="bi bi-arrow-down-short"></i> Sort: Largest First
                    {% endif %}
                </a>
            </div>

            <p class="text-muted">Displaying {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_count|intcomma }} components with capacity data.</p>

            <ul class="list-group list-group-flush mb-4">
                {% for component in page_obj.object_list %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                             <a href="{% url 'component_detail' pk=component.id %}" class="fw-bold text-decoration-none">
                                {{ component.location|truncatechars:80|default:"No Location Info" }}
                            </a>
                            <span class="badge bg-info rounded-pill">{{ component.derated_capacity_mw|floatformat:2|intcomma }} MW</span>
                        </div>
                        <div class="small text-muted">
                            {{ component.technology|truncatechars:70|default:"No Technology Info" }}
                        </div>
                        {% if component.description %}
                        <div class="small text-muted mt-1">
                            <i>{{ component.description|truncatechars:100 }}</i>
                        </div>
                        {% endif %}
                    </li>
                {% empty %}
                    <li class="list-group-item">No components with de-rated capacity data found for this company.</li>
                {% endfor %}
            </ul>

            <!-- Pagination for Capacity View -->
            {% if paginator.num_pages > 1 %}
                <nav aria-label="Component navigation" class="pagination-nav">
                    <ul class="pagination justify-content-center">
                        {% with base_url="?view_mode=capacity&sort="|add:sort_order %}
                        {% if page_obj.has_previous %}
                            <li class="page-item"><a class="page-link" href="{{ base_url }}&page=1">First</a></li>
                            <li class="page-item"><a class="page-link" href="{{ base_url }}&page={{ page_obj.previous_page_number }}">Previous</a></li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">First</span></li>
                            <li class="page-item disabled"><span class="page-link">Previous</span></li>
                        {% endif %}

                        {% for i in page_obj.paginator.get_elided_page_range %}
                            {% if i == page_obj.number %}
                                <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
                            {% elif i == page_obj.paginator.ELLIPSIS %}
                                 <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% else %}
                                <li class="page-item"><a class="page-link" href="{{ base_url }}&page={{ i }}">{{ i }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item"><a class="page-link" href="{{ base_url }}&page={{ page_obj.next_page_number }}">Next</a></li>
                            <li class="page-item"><a class="page-link" href="{{ base_url }}&page={{ paginator.num_pages }}">Last</a></li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">Next</span></li>
                            <li class="page-item disabled"><span class="page-link">Last</span></li>
                        {% endif %}
                        {% endwith %}
                    </ul>
                </nav>
            {% endif %}

        </div>

    {% else %}
        {# --- YEAR/AUCTION VIEW (Existing Logic) --- #}
        <div class="year-auction-view">
            <p class="text-muted mb-3">Showing components grouped by delivery year and auction.</p>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Click on a year to view details. Click on an auction to load components.
            </div>

            <!-- Sort toggle for years (Keep original logic if needed, or remove if only desc sort is desired) -->
             <div class="mb-3 d-flex align-items-center">
                <!-- Note: Sorting years might be less relevant now, consider removing? -->
                {% if sort_order == "desc" %}
                    <a href="?view_mode=year_auction&sort=asc" class="sort-toggle">
                        <i class="bi bi-arrow-up-short"></i> Sort Years: Oldest First
                    </a>
                {% else %}
                    <a href="?view_mode=year_auction&sort=desc" class="sort-toggle">
                        <i class="bi bi-arrow-down-short"></i> Sort Years: Newest First
                    </a>
                {% endif %}
                
                <button id="collapse-all-button" class="btn btn-outline-secondary ms-2 btn-sm">
                    <i class="bi bi-arrows-collapse"></i> Collapse All
                </button>
            </div>

            <div class="years-container">
                {% for year_info in year_auction_data %}
                    <button class="year-button btn btn-light border mb-2 w-100 text-start fw-bold" data-target="year-content-{{ year_info.year_id }}">
                        Delivery Year: {{ year_info.year }} <i class="bi bi-chevron-down float-end"></i>
                    </button>
                    <div id="year-content-{{ year_info.year_id }}" class="year-content collapse border rounded p-3 mb-2">
                        {% for auction_name, auction_id, badge_class, auction_type in year_info.auctions_display %}
                            <button id="button-{{ auction_id }}" class="auction-button btn btn-outline-dark mb-2 w-100 text-start" data-target="auction-content-{{ auction_id }}">
                                <span class="badge {{ badge_class }} me-2">{{ auction_type }}</span>
                                Auction: {{ auction_name }} <i class="bi bi-chevron-down float-end"></i>
                            </button>
                            <div id="auction-content-{{ auction_id }}" class="auction-content collapse border rounded p-3 mb-2"
                                 hx-get="/api/auction-components/{{ company_id }}/{{ year_info.year|url_safe }}/{{ auction_name|url_safe }}/"
                                 hx-trigger="intersect once"
                                 hx-target="find .auction-data"
                                 hx-indicator="#spinner-{{ auction_id }}"
                                 hx-swap="innerHTML">
                                <div class="auction-data">
                                    <div class="text-center p-4 loading-placeholder">
                                        <div class="spinner-border spinner-border-sm htmx-indicator" role="status" id="spinner-{{ auction_id }}"></div>
                                        <span class="text-muted ms-2">Loading components for {{ auction_name }}...</span>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                             <p class="text-muted ms-3">No specific auctions listed for this year.</p>
                        {% endfor %}
                    </div>
                {% empty %}
                    <div class="alert alert-warning">No delivery year data found for this company.</div>
                {% endfor %}
            </div>
        </div>
    {% endif %} {# End view_mode conditional #}

    <!-- API Time -->
    {% if api_time > 0 %}
        <p class="text-muted mt-3">API request took {{ api_time|floatformat:2 }} seconds.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Year/Auction View JS --- 
        const yearAuctionView = document.querySelector('.year-auction-view');
        if (yearAuctionView) {
            // Handle "Collapse All" button
            const collapseAllBtn = document.getElementById('collapse-all-button');
            if (collapseAllBtn) {
                collapseAllBtn.addEventListener('click', function() {
                    document.querySelectorAll('.year-content.show, .auction-content.show').forEach(content => {
                        new bootstrap.Collapse(content).hide();
                        const triggerBtn = document.querySelector(`[data-target="${content.id}"] i.bi`);
                        if (triggerBtn) triggerBtn.classList.replace('bi-chevron-up', 'bi-chevron-down');
                    });
                });
            }

            // Handle year button clicks
            document.querySelectorAll('.year-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetContent = document.getElementById(targetId);
                    const icon = this.querySelector('i.bi');
                    if (targetContent) {
                        const bsCollapse = new bootstrap.Collapse(targetContent, { toggle: false });
                        bsCollapse.toggle();
                        if (icon) icon.classList.toggle('bi-chevron-down');
                        if (icon) icon.classList.toggle('bi-chevron-up');
                    }
                });
            });

            // Handle auction button clicks - also triggers HTMX loading via event
            document.querySelectorAll('.auction-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetContent = document.getElementById(targetId);
                    const icon = this.querySelector('i.bi');
                    if (targetContent) {
                        const bsCollapse = new bootstrap.Collapse(targetContent, { toggle: false });
                        bsCollapse.toggle();
                        if (icon) icon.classList.toggle('bi-chevron-down');
                        if (icon) icon.classList.toggle('bi-chevron-up');
                        
                        // If opening, trigger HTMX load if not already loaded/loading
                        if (targetContent.classList.contains('show')) {
                             // Check if content is just the placeholder
                            const placeholder = targetContent.querySelector('.loading-placeholder');
                            if (placeholder) {
                                htmx.trigger(targetContent, 'load-components');
                            }
                        }
                    }
                });
            });
            
            // Add HTMX error handling
            document.body.addEventListener('htmx:responseError', function(evt) {
                const targetElement = evt.detail.elt;
                console.error('HTMX Error:', evt.detail.xhr.status, evt.detail.xhr.statusText);
                const auctionData = targetElement.querySelector('.auction-data');
                if (auctionData) {
                    auctionData.innerHTML = `<div class="alert alert-danger py-2">Error loading components.</div>`;
                }
            });
            
             // Optional: Use Bootstrap Collapse events for better HTMX trigger timing
            document.querySelectorAll('.auction-content').forEach(el => {
                el.addEventListener('shown.bs.collapse', event => {
                    const placeholder = el.querySelector('.loading-placeholder');
                    if (placeholder) {
                        htmx.trigger(el, 'load-components');
                    }
                })
            });
        } // end if (yearAuctionView)
    });
</script>
{% endblock %}