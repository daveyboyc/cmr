{% extends "checker/base.html" %}
{% load static %}

{% block title %}My Account{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <h1 class="mb-4">My Account</h1>
        
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                Account Details
            </div>
            <div class="card-body">
                <p><strong>Username:</strong> {{ user.username }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                <a href="{% url 'accounts:custom_password_change' %}" class="btn btn-outline-secondary btn-sm">Change Password</a>
                {# Add link to update email/other details if implemented later #}
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                Access Status
            </div>
            <div class="card-body">
                <div id="access-status">
                    {# Status message will be updated by JavaScript #}
                    Loading access status...
                </div>
                <div id="access-timer" class="mt-2" style="font-weight: bold; color: var(--bs-warning);">
                    {# Timer countdown will be displayed here #}
                </div>
                <div id="upgrade-now-area" class="mt-3">
                    {# Upgrade button will be visible during free trial #}
                    <p class="text-info mb-2">Don't wait until your free access expires!</p>
                    <a href="{% url 'accounts:initiate_payment' %}" class="btn btn-warning">
                        <i class="bi bi-credit-card-2-front-fill me-2"></i>Upgrade Now (Â£5 One-Off Payment)
                    </a>
                </div>
                <div id="payment-link-area" class="mt-3" style="display: none;">
                     {# Payment link/button will appear here when timer expires #}
                     <p class="text-danger mb-2">Your free access period has expired.</p>
                     {# Link will eventually point to the payment initiation view #}
                     <a href="{% url 'accounts:initiate_payment' %}" class="btn btn-warning">Upgrade for Full Access</a> {# Updated with correct URL #}
                </div>
            </div>
        </div>

        <!-- Contact Information Card -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-envelope-fill me-2"></i>Need Help?
            </div>
            <div class="card-body">
                <p>If you have any questions or need assistance with your account, our support team is here to help.</p>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5><i class="bi bi-envelope me-2"></i>Email Us</h5>
                        <p>For account issues, billing questions, or general support:</p>
                        <p><a href="mailto:hello@capacitymarket.co.uk" class="btn btn-outline-primary">
                            hello@capacitymarket.co.uk
                        </a></p>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="bi bi-clock me-2"></i>Response Time</h5>
                        <p>We typically respond to all inquiries within 1-2 business days.</p>
                        <p>For urgent matters, please include "URGENT" in your subject line.</p>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="bi bi-info-circle-fill fs-4"></i>
                        </div>
                        <div>
                            <strong>Capacity Market Registry Support Office</strong><br>
                            Innovation Hub<br>
                            35 Energy Square<br>
                            London, EC2A 4PB<br>
                            United Kingdom
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ has_paid_access|json_script:"has-paid-access-data" }}
{{ user.last_login|date:"U"|default:"null"|json_script:"last-login-timestamp-data" }} {# Pass last login as Unix timestamp #}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hasPaidAccessData = JSON.parse(document.getElementById('has-paid-access-data').textContent);
    const accessStatusDiv = document.getElementById('access-status');
    const accessTimerDiv = document.getElementById('access-timer');
    const paymentLinkArea = document.getElementById('payment-link-area');
    const upgradeNowArea = document.getElementById('upgrade-now-area');
    
    let countdownInterval = null; // To store the interval ID
    let expiryTimeout = null; // To store the timeout ID

    console.log("Account page loaded. Has paid access:", hasPaidAccessData);

    // --- Helper Function to Format Time ---
    function formatTime(totalSeconds) {
        if (totalSeconds < 0) totalSeconds = 0;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // --- Function to Handle Timer Expiry ---
    function handleExpiry() {
        console.log("Timer expired. Showing payment link.");
        if (countdownInterval) clearInterval(countdownInterval); // Stop the countdown
        accessStatusDiv.textContent = "Free access expired.";
        accessStatusDiv.classList.add('text-danger');
        accessTimerDiv.style.display = 'none';
        upgradeNowArea.style.display = 'none'; // Hide upgrade now button
        paymentLinkArea.style.display = 'block';
        sessionStorage.removeItem('freeAccessStartTime'); // Clean up storage
    }

    // --- Main Logic ---
    if (hasPaidAccessData === true) {
        accessStatusDiv.textContent = "Full access active.";
        accessTimerDiv.style.display = 'none'; 
        upgradeNowArea.style.display = 'none'; // Hide upgrade button for paid users
        paymentLinkArea.style.display = 'none';
    } else {
        // Free access logic
        const TOTAL_FREE_SECONDS = 86400; // 24 hours
        const storageKey = 'freeAccessStartTime';
        let startTime = sessionStorage.getItem(storageKey);

        if (!startTime) {
            startTime = Date.now();
            sessionStorage.setItem(storageKey, startTime);
            console.log("Free access timer started at:", new Date(startTime));
        } else {
            startTime = parseInt(startTime); // Convert stored string back to number
            console.log("Free access timer resumed from:", new Date(startTime));
        }

        const now = Date.now();
        const elapsedMilliseconds = now - startTime;
        const remainingMilliseconds = (TOTAL_FREE_SECONDS * 1000) - elapsedMilliseconds;

        if (remainingMilliseconds <= 0) {
            // Already expired when page loaded
            handleExpiry();
        } else {
            // Timer is active
            accessStatusDiv.textContent = "Free access period active.";
            paymentLinkArea.style.display = 'none';
            upgradeNowArea.style.display = 'block'; // Show upgrade button during free period
            accessTimerDiv.style.display = 'block';

            const updateTimerDisplay = () => {
                const currentNow = Date.now();
                const currentElapsed = currentNow - startTime;
                const currentRemainingSeconds = Math.round(((TOTAL_FREE_SECONDS * 1000) - currentElapsed) / 1000);
                
                if (currentRemainingSeconds <= 0) {
                    handleExpiry(); // Trigger expiry if time runs out during interval check
                } else {
                    accessTimerDiv.textContent = `Time remaining: ${formatTime(currentRemainingSeconds)}`;
                }
            };

            updateTimerDisplay(); // Initial display
            countdownInterval = setInterval(updateTimerDisplay, 1000); // Update every second

            // Set a timeout for the exact remaining duration to trigger expiry
            expiryTimeout = setTimeout(handleExpiry, remainingMilliseconds);
            console.log(`Set expiry timeout for ${remainingMilliseconds}ms`);
        }
    }

});
</script>
{% endblock %} 